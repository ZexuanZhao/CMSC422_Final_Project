---
title: "Replicate DT"
author: "Zexuan Zhao"
date: "2022-12-05"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(randomForest)
library(ggVennDiagram)
library(tidyverse)
```

Import the data set provided by the paper.
```{r}
data <- read_csv("AppendixS1.csv") %>% 
  select(-Species, -Genus, -Family, -Order, -Class, -Phylum, -Kingdom) %>% 
  select(-r, -c, -t, -p,	-f,	-fp,	-cgeo,	-tgeo,	-pgeo,	-cenv,	-tenv,	-penv) %>% 
  select(-pmtr, -dgr, -der, -ger, -bp, -pi) %>% 
  na.omit() %>% 
  filter(n > 10)

data <- data %>% 
  mutate(pmtp = p.adjust(pmtp, method = "BH"),
         dgp = p.adjust(dgp, method = "BH"),
         dep = p.adjust(dep, method = "BH"),
         gep = p.adjust(gep, method = "BH"))
```

Code p-value as "yes or no"
`pmtp` is generated by `mantel.partial(mydata.dnadist, mydata.geodist, mydata.envdist, method = "pearson", permutations = 999)`
which is the probability that DNA distance is correlated with geographical distance, with environemental distance corrected.

```{r}
data %>% 
  ggplot(aes(x = pmtp)) +
    geom_histogram() +
    scale_x_log10()

data %>% 
  ggplot(aes(x = dgp)) +
    geom_histogram() +
    scale_x_log10()

data %>% 
  ggplot(aes(x = dep)) +
    geom_histogram() +
    scale_x_log10()

data %>% 
  ggplot(aes(x = gep)) +
    geom_histogram() +
    scale_x_log10()
```

```{r}
data %>% 
  ggplot(aes(x = dgp, y = dep, color = log(gep))) + 
    geom_point()
```

```{r}
sig_level <- 0.05
data_sig_level <- data %>% 
  mutate(pmtp = ifelse(pmtp > sig_level, FALSE, TRUE) ) %>% 
  mutate(dgp = ifelse(dgp > sig_level, FALSE, TRUE) ) %>% 
  mutate(dep = ifelse(dep > sig_level, FALSE, TRUE) ) %>% 
  mutate(gep = ifelse(gep > sig_level, FALSE, TRUE) )

data_sig_level %>% 
  group_by(dgp, dep, gep) %>% 
  summarize(n = n())

data_sig_level_venn <- data_sig_level %>% 
  mutate(index = 1:n()) %>% 
  mutate(pmtp = ifelse(pmtp, index, NA) ) %>% 
  mutate(dgp = ifelse(dgp, index, NA) ) %>% 
  mutate(dep = ifelse(dep, index, NA) ) %>% 
  mutate(gep = ifelse(gep, index, NA) )

venn_list <- list(#pmtp = data_sig_level_venn$pmtp,
                  dgp = data_sig_level_venn$dgp %>% na.omit(),
                  dep = data_sig_level_venn$dep %>% na.omit(),
                  gep = data_sig_level_venn$gep %>% na.omit())
ggVennDiagram(venn_list)
```

```{r}
data_sig_level_transformed <- data_sig_level %>% 
  mutate(y = ifelse(dgp & dep, "both",
                    ifelse(dgp, "geo",
                           ifelse(dep, "env", "none"))) %>% as.factor()) %>% 
  select(-dgp, -dep, -pmtp)
```

Run random forest on original data set:

```{r}
data_pmtp <- data %>% 
  select(-dgp, -dep, -gep) %>% 
  mutate(pmtp = ifelse(pmtp <= sig_level, TRUE, FALSE) %>% as.factor())
rf <- randomForest(pmtp ~ ., data=data_pmtp, ntree=1000, importance=TRUE, nPerm=100)
rf[["confusion"]]
data_pmtp$pmtp %>% table()
```

```{r}
imp <- importance(rf) %>%
  as_tibble(rownames = "var") %>% 
  arrange(desc(MeanDecreaseAccuracy))
```


Run random forest on 4 classes data set
```{r}
rf2 <- randomForest(y ~ ., data=data_sig_level_transformed, ntree=1000, importance=TRUE, nPerm=100)
rf2[["confusion"]]
```


```{r}
imp2 <- importance(rf2) %>%
  as_tibble(rownames = "var") %>% 
  arrange(desc(MeanDecreaseAccuracy))
```


